<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>BattleTanks - Iron War</title>
    <!-- link to the last version of babylon -->
    <script src="scripts\babylon.custom.js"></script>
    <script src="scripts\babylon.objFileLoader.js"></script>
    <link rel="stylesheet" href="style\style.css">

</head>
<body>
    <canvas id="renderCanvas"></canvas>


    <script>

        window.addEventListener('DOMContentLoaded', function()
        {
            // your code here

        });

        //var player;
        var tank = [];
        var bots = [];
        var shoots = [];
        var p1;
        var ctx;
        var cam = 0;

        var points = 0;
        var ground;


        function Player(mesh)
        {
            this.player = mesh;
            this.HP = 100;
            this.power = 1;
            this.speed = 0.008;
            this.gravity = 0.15;

            this.bullets = [];

            this.createPlayer=function(scene)
            {
                this.player.position = new BABYLON.Vector3(-20, 15, 10);
                this.player.physicsImpostor = new BABYLON.PhysicsImpostor(this.player, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.51, restitution: 0 }, scene);
                //this.player.showBoundingBox = true;
            }

            this.shoot=function(scene)
            {
                this.bullets.push(BABYLON.Mesh.CreateSphere("sphere", 10.0, 0.1, scene));

                var rotz = p1.player.rotationQuaternion.toEulerAngles();
                var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / this.speed, 0, parseFloat(Math.cos(rotz.y)) / this.speed);

                this.bullets[this.bullets.length - 1].position = new BABYLON.Vector3(this.player.position.x, this.player.position.y + 4, this.player.position.z);
                this.bullets[this.bullets.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(this.bullets[this.bullets.length - 1], BABYLON.PhysicsImpostor.SphereImpostor, { mass: 1, restitution: 0.9 }, scene);
                this.bullets[this.bullets.length - 1].applyImpulse(backwards.negate(), this.bullets[this.bullets.length - 1].position);
            }
        }

        function check(scene)
        {
            var groundHit = false;
            for(i = 0; i < p1.bullets.length; i++)
            {
                p1.bullets[i].physicsImpostor.registerOnPhysicsCollide(ground.physicsImpostor, function(main, collided)
                {
                    alert("hitGround"+i);
                    //p1.bullets[i] = null;
                    p1.bullets.pop();
                    groundHit=true;
                    return;
                });
                if(groundHit)
                    continue;

                for(j = 0; j < bots.length; j++)
                {
                    p1.bullets[i].physicsImpostor.registerOnPhysicsCollide(bots[j].physicsImpostor, function(main, collided)
                    {
                        points++;

                        //main.object.showBoundingBox = false;
                        p1.HP -= 10;
                        alert(p1.HP);
                        p1.bullets.pop();
                        //p1.bullets[i] = null;
                    });
                }
            }
        }




        function createBots(number, scene)
        {
            for(i = 0; i < number; i++)
            {
                bots.push(p1.player.clone());
                bots[bots.length - 1].position =  new BABYLON.Vector3(-5*i, 20, 10*i-10);
                bots[bots.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(bots[bots.length - 1], BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.51, restitution: 0 }, scene);
            }
        }


        var canvas = document.getElementById('renderCanvas');
        var engine = new BABYLON.Engine(canvas, true);

        var createScene = function()
        {
            var scene = new BABYLON.Scene(engine);

            var gravityVector = new BABYLON.Vector3(0,-9.81, 0);
            var physicsPlugin = new BABYLON.CannonJSPlugin();

            scene.enablePhysics(gravityVector, physicsPlugin);



            var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);


            BABYLON.SceneLoader.ImportMesh("", "", "tank.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat0", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/Main Body.png", scene);

                tankMaterials[1] = new BABYLON.StandardMaterial("Mat1", scene);
                tankMaterials[1].diffuseTexture = new BABYLON.Texture("assets/player/Main Body 2.png", scene);

                tankMaterials[2] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[2].diffuseTexture = new BABYLON.Texture("assets/player/Turret.png", scene);

                tankMaterials[3] = new BABYLON.StandardMaterial("Mat3", scene);
                tankMaterials[3].diffuseTexture = new BABYLON.Texture("assets/player/Gun.png", scene);


                for(i = 0; i < tank.length; i++)
                {
                    tank[i].material = tankMaterials[i];
                }


                p1 = new Player(BABYLON.Mesh.MergeMeshes(tank));
                FPCamera.lockedTarget = p1.player;

                p1.createPlayer(scene);

                createBots(3, scene);



            });

            var controlCamera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 15, 45), scene);
            controlCamera.setTarget(BABYLON.Vector3.Zero());
            //controlCamera.attachControl(canvas, false);

            var FPCamera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 15, 45), scene);
            FPCamera.radius = 30;
            FPCamera.heightOffset = 10; //10
            FPCamera.rotationOffset = 0;

            scene.activeCamera = FPCamera;
            //scene.activeCamera = controlCamera;


            var skybox = BABYLON.Mesh.CreateBox("skyBox", 400.0, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/skybox/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;



            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("assets/mesh.png", scene);


            ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "assets/mesh.png", 200, 200, 50, 0, 40, scene, false, function ()
            {
                ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0}, scene);
                ground.material = groundMaterial;

            });



            /*
            var ground = BABYLON.Mesh.CreateGround('ground1', 60, 60, 2, scene);
            ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
            ground.material = groundMaterial;
            */








        	window.addEventListener("keydown", function(evt)
            {
                canvas.children[0].text = "Score: " + points;
                switch(evt.keyCode)
                {
                    case 65:        p1.player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);


                                    //p1.player.updatePhysicsBodyPosition();
                                    //p1.player.rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(0, -0.05, 0);
                                    //p1.player.rotation.y -= 0.1;

                    //A
                                    break;

                    case 87:        p1.player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);


                    //W


                                    /*
                                    var rotz = p1.player.rotationQuaternion.toEulerAngles();
                                    var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / p1.speed, p1.player.position.y, parseFloat(Math.cos(rotz.y)) / p1.speed);


                                    p1.player.applyImpulse(backwards.negate(), p1.player);
                                    */
                                    break;


                    case 68:
                                    //p1.player.rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(0, 0.05, 0);
                                    p1.player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);
                                    //p1.player.rotation.y += 0.1;
                                    //p1.player.rotation = new BABYLON.Vector3(0, 1, 0);
                                    break;

                    case 83:        /*
                                    var up_local = new BABYLON.Vector3(0, 0, 0.5);
                                    var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);
                                    player.applyImpulse(up_global, player.position);
                                    player.setLinearVelocity.scaleEqual(0.5);
                                    break;      //S     */

                                    p1.player.translate(BABYLON.Axis.Z, 0.5, BABYLON.Space.LOCAL);
                                    break;

                    case 32:        p1.shoot(scene);


                                    break;      //SPACE

                    case 86:
                                    cam = ++cam % 3;
                                    switch(cam)
                                    {
                                            case 0:     scene.activeCamera = FPCamera;
                                                        FPCamera.lockedTarget = p1.player;
                                                        FPCamera.radius = 30;
                                                        FPCamera.heightOffset = 10;
                                                        break;

                                            case 1:     scene.activeCamera = FPCamera;
                                                        FPCamera.lockedTarget = p1.player;
                                                        FPCamera.radius = 30;
                                                        FPCamera.heightOffset = 80;
                                                        break;

                                            case 2:     scene.activeCamera = controlCamera;
                                                        //controlCamera.attachControl(canvas, false);
                                                        break;
                                    }



                                    break;//V (VIEW)
                }
        	}, false);

            /*
            var backgroundTexture = new BABYLON.DynamicTexture("dynamic texture", {width:1024, height:512}, scene, true);
            var context = backgroundTexture.getContext();
            context.fillRect(10, 10, 55, 50);
            backgroundTexture.update();
            */

            /*
            var d = 50;
            var cubes = new Array();
            for (var i = 0; i < 360; i += 20) {
                var r = BABYLON.Tools.ToRadians(i);
                var b = BABYLON.Mesh.CreateBox("Box #" + i / 20, 5, scene, false);
                b.position.x = Math.cos(r) * d;
                b.position.z = Math.sin(r) * d;
                cubes.push(b);
            }
            var canvas = new BABYLON.ScreenSpaceCanvas2D(scene, {
                id: "ScreenCanvas"
            });
            i = 0;
            for (var _i = 0, cubes_1 = cubes; _i < cubes_1.length; _i++) {
                var cube = cubes_1[_i];
                new BABYLON.Group2D({
                    parent: canvas, id: "GroupTag #" + i, width: 80, height: 40, trackNode: cube, origin: BABYLON.Vector2.Zero(),
                    children: [
                        new BABYLON.Rectangle2D({ id: "firstRect", width: 80, height: 26, x: 0, y: 0, origin: BABYLON.Vector2.Zero(), border: "#FFFFFFFF", fill: "#808080FF", children: [
                                new BABYLON.Text2D(cube.name, { marginAlignment: "h: center, v:center", fontName: "bold 12px Arial" })
                            ]
                        })
                    ]
                });
                ++i;
            }*/




            var canvas = new BABYLON.ScreenSpaceCanvas2D(scene,
            {
                id: "ScreenCanvas",
                size: new BABYLON.Size(300, 80),
                backgroundFill: "#4040408F",
                //backgroundRoundRadius: 50,
                children: [ new BABYLON.Text2D("Score "+points,
                {
                    id: "text",
                    marginAlignment: "h: center, v:center",
                    fontName: "20pt Arial",
                })]
            });



        /*
        var buttonRect = new BABYLON.Rectangle2D(
        {
            parent: canvas,
            id: "button",
            x: 100,
            y: 100,
            width: 200,
            height: 80,
            fill: "#40C040FF",
            roundRadius: 10,
            children:
            [
                new BABYLON.Text2D("Click Me!", { fontName: "30pt Arial", marginAlignment: "h: center, v: center" })
            ]
        });
        */

            return scene;
    }

    var scene = createScene();
    engine.runRenderLoop(function() {
        if(scene.isReady())
            check(scene);
        scene.render();


    });

    window.addEventListener('resize', function() {
        engine.resize();
    });

    </script>
</body>
</html>
