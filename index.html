<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>BattleTanks - Iron War</title>
    <!-- link to the last version of babylon -->
    <script src="scripts\babylon.custom.js"></script>
    <script src="scripts\babylon.objFileLoader.js"></script>
    <link rel="stylesheet" href="style\style.css">

</head>
<body>
    <canvas id="renderCanvas" onclick="handleClick(event)" onmousemove="handleMove(event)"></canvas>


    <script>

        window.addEventListener('DOMContentLoaded', function()
        {
            // your code here

        });

        //var player;
        var tank = [];
        var bots = [];
        var shoots = [];
        var p1;
        var ctx;
        var cam = 0;

        var points = 0;
        var ground;

        var gameActive = false;

        var enemies = 3;

        var level = 1;



        function Player(name, mesh)
        {
            this.name = name;
            this.player = mesh;

                this.hp = 100;

                this.cannonDamage = 5;

                this.mineDamage = 0;

            this.speed = 0.008;
            this.gravity = 0.15;

            this.bullets = [];

            this.mineLimit = 1;
            this.mines = [];

            this.upgrades = 2;



            this.createPlayer=function(scene)
            {
                this.player.position = new BABYLON.Vector3(-20, 15, 50);
                this.player.physicsImpostor = new BABYLON.PhysicsImpostor(this.player, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.91, restitution: 0 }, scene);
                //this.player.showBoundingBox = true;


                new BABYLON.Group2D(
                {
                    parent: menuCanvas.children[3], id: "Player", width: 80, height: 40, trackNode: p1.player, origin: BABYLON.Vector2.Zero(),
                    children:
                    [
                        new BABYLON.Rectangle2D(
                        {
                            id: "firstPlayer", width: 60, height: 15, x: 0, y: 0, origin: BABYLON.Vector2.Zero(), border: "#FFFFFFFF", fill: "#40C040CC"
                        })
                    ]
                });
                menuCanvas.children[3].children[0].children[0].levelVisible = false;

            }

            this.shoot=function(scene)
            {
                this.bullets.push(BABYLON.Mesh.CreateSphere("sphere", 10.0, 0.2, scene));

                var rotz = this.player.rotationQuaternion.toEulerAngles();
                var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / this.speed, rotz.x*10 +2, parseFloat(Math.cos(rotz.y)) / this.speed);

                this.bullets[this.bullets.length - 1].position = new BABYLON.Vector3(this.player.position.x + (parseFloat(Math.sin(rotz.y)) / 0.2)*(-1), this.player.position.y + rotz.x*10 +2, this.player.position.z + (parseFloat(Math.cos(rotz.y)) / 0.2)*(-1));

                this.bullets[this.bullets.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(this.bullets[this.bullets.length - 1], BABYLON.PhysicsImpostor.SphereImpostor, { mass: 1, restitution: 0 }, scene);
                this.bullets[this.bullets.length - 1].applyImpulse(backwards.negate(), this.bullets[this.bullets.length - 1].position);
            }

            this.upgradePrimary=function()
            {
                this.cannonDamage += 5;
            }

            this.upgradeSecundary=function()
            {
                this.mineDamage += 5;
            }

            this.upgradeHealth=function()
            {
                this.hp += 10;
            }

            this.plant=function()
            {
                this.mines.push(mine.clone());

                this.mines[this.mines.length -1].scaling = new BABYLON.Vector3(0.15, 0.15, 0.15);
                this.mines[this.mines.length -1].rotate(BABYLON.Axis.X, 1, BABYLON.Space.LOCAL);


                var rotz = this.player.rotationQuaternion.toEulerAngles();
                var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / this.speed , rotz.x*10 +2, parseFloat(Math.cos(rotz.y)) / this.speed);

                this.mines[this.mines.length - 1].position = new BABYLON.Vector3(this.player.position.x + (parseFloat(Math.sin(rotz.y)) / 0.15), this.player.position.y + rotz.x*10 +2 , this.player.position.z + (parseFloat(Math.cos(rotz.y)) / 0.15));

                this.mines[this.mines.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(this.mines[this.mines.length - 1], BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, restitution: 0 }, scene);

            }
        }

        var globalnii = 0;
        var globalnij = 0;


        var groundHit;
        var targetHit;

        function check(scene)
        {

            groundHit = false;
            targetHit = false;

            if(p1 == null)
                return;

            for(i = 0; i < p1.bullets.length; i++)
            {
                globalnii = i;
                p1.bullets[i].physicsImpostor.registerOnPhysicsCollide(ground.physicsImpostor, function(main, collided)
                {
                    if(p1.bullets.length == 0)
                        return;

                    p1.bullets.splice(globalnii, 1);

                    groundHit=true;
                    return;
                });
                if(groundHit)
                {
                    i--;
                    continue;
                }


                for(j = 0; j < bots.length; j++)
                {
                    if(bots[j] == null)
                        continue;

                    if(p1.bullets[i].intersectsMesh(bots[j].player, true))
                    {
                        bots[j].hp -= p1.cannonDamage;
                        p1.bullets[i].dispose();
                        p1.bullets.splice(globalnii, 1);
                        i--;

                        var length = menuCanvas.children[3].children[j+1].children[0].width;

                        if( length < 35 && length > 25 )
                            menuCanvas.children[3].children[j+1].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                        else if(length < 25)
                            menuCanvas.children[3].children[j+1].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                        menuCanvas.children[3].children[j+1].children[0].width -= 5;

                        if(bots[j].hp <= 0)
                        {
                            menuCanvas.children[3].children[j+1].children[0].levelVisible = false;
                            bots[j].player.dispose();
                            bots[j] = null;
                            enemies--;
                            //bots.splice(j, 1);
                            //j--;
                        }

                        break;
                    }



                }
            }

            for(i = 0; i < p1.mines.length; i++)
            {
                for(j = 0; j < bots.length; j++)
                {
                    if(bots[j] == null)
                        continue;

                    if(p1.mines[i].intersectsMesh(bots[j].player, true))
                    {
                        bots[j].hp -= p1.mineDamage;
                        p1.mines[i].dispose();
                        p1.mines.splice(i, 1);
                        i--;

                        var length = menuCanvas.children[3].children[j+1].children[0].width;

                        if( length < 35 && length > 25 )
                            menuCanvas.children[3].children[j+1].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                        else if(length < 25)
                            menuCanvas.children[3].children[j+1].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                        menuCanvas.children[3].children[j+1].children[0].width -= 5;

                        if(bots[j].hp <= 0)
                        {
                            menuCanvas.children[3].children[j+1].children[0].levelVisible = false;
                            bots[j].player.dispose();
                            bots[j] = null;
                            enemies--;
                            //bots.splice(j, 1);
                            //j--;
                        }

                        break;
                    }


                }

                if(p1.mines[i].intersectsMesh(p1.player, true))
                {
                    p1.hp -= p1.mineDamage;
                    p1.mines[i].dispose();
                    p1.mines.splice(i, 1);
                    i--;

                    var length = menuCanvas.children[3].children[0].children[0].width;

                    if( length < 35 && length > 25 )
                        menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                    else if(length < 25)
                        menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                    menuCanvas.children[3].children[0].children[0].width -= 5;

                    break;
                }

            }


            if(upgrades2 != null && p1.player.intersectsMesh(upgrades2, true))
            {
                p1.upgrades++;
                upgrades2.dispose();
            }
        }

        var woodenBox;
        var upgrades2;
        function createUpgradeBox()
        {
            if(upgrades2 != null)
                upgrades2.dispose();
            upgrades2 = woodenBox.clone();
            upgrades2.position = new BABYLON.Vector3(Math.floor(Math.random() * 200)-100, 15, Math.floor(Math.random() * 200)-100);
            upgrades2.physicsImpostor = new BABYLON.PhysicsImpostor(upgrades2, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.91, restitution: 0 }, scene);
        }

        function createBots(scene)
        {
            for(i = 0; i < bots.length; i++)
            {
                //bots[bots.length - 1].player.setAbsolutePosition(new BABYLON.Vector3(-20 * i , 20, 15));
                bots[i].player.position =  new BABYLON.Vector3(-20 * i , 20, 15);
                bots[i].player.physicsImpostor = new BABYLON.PhysicsImpostor(bots[i].player, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.91, restitution: 0 }, scene);

                new BABYLON.Group2D(
                {
                    parent: menuCanvas.children[3], id: "Botd#" + i, width: 80, height: 40, trackNode: bots[i].player, origin: BABYLON.Vector2.Zero(),
                    children:
                    [
                        new BABYLON.Rectangle2D(
                        {
                            id: "firstRecto"+i, width: 60, height: 10, x: 0, y: 0, origin: BABYLON.Vector2.Zero(), border: "#FFFFFFFF", fill: "#40C040CC"
                        })
                    ]
                });

                menuCanvas.children[3].children[i+1].children[0].levelVisible = false;
            }

        }

        var tempL = 15;
        var tempD = 14;
        function move()
        {
            for(i = 0; i < bots.length; i++)
            {


                if(Math.floor((Math.random() * 1280)) == 11)
                    tempL = 15;

                else if (Math.floor((Math.random() * 1280)) == 10)
                    tempD = 14;

                if(tempL > 0)
                {
                    bots[i].player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);
                    tempL--;
                }
                else if(tempD > 0)
                {
                    bots[i].player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);
                    tempD--;
                }
                else
                {
                    bots[i].player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);
                }


                if(Math.floor((Math.random() * 1280)) < 100)
                    bots[i].shoot(scene);
            }
        }


        var canvas = document.getElementById('renderCanvas');
        var engine = new BABYLON.Engine(canvas, true);


        var activeScreen = "main";



        function create2D(scene)
        {

            var mainWindow = new BABYLON.Texture("assets/mainMenu.png", scene);
            mainWindow.hasAlpha = true;

            var upgradeWindow = new BABYLON.Texture("assets/upgradeMenu.png", scene);
            var upgradeButton = new BABYLON.Texture("assets/upgradeButton.png", scene);
            upgradeWindow.hasAlpha = true;
            upgradeButton.hasAlpha = true;

            var lol = new BABYLON.Texture("assets/enemies2.png", scene);
            var lol2 = new BABYLON.Texture("assets/score.png", scene);
            var lvl = new BABYLON.Texture("assets/level.png", scene);
            lol2.hasAlpha = true;
            lol.hasAlpha = true;
            lvl.hasAlpha = true;

            menuCanvas = new BABYLON.ScreenSpaceCanvas2D(scene,
            {
                id: "ScreenCanvas",
                size: new BABYLON.Size(engine.getRenderWidth(), engine.getRenderHeight()),
                backgroundFill: "#50505055",
                children:
                [
                    new BABYLON.Group2D(
                    {
                        id: "GroupTag #", children:
                        [
                            new BABYLON.Sprite2D(mainWindow,
                            {
                                id: "mainWindow", marginAlignment: "h: center, v:center"
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(1080, 370), new BABYLON.Vector2(1240, 370)], {
                                id: "play",
                                border: "#FFFFFFFF", borderThickness: 2
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(440, 285), new BABYLON.Vector2(760, 285)], {
                                id: "upgrades",
                                border: "#98181fFF", borderThickness: 2
                            })
                        ]
                    }),
                    new BABYLON.Group2D(
                    {
                        id: "GroupTag #", children:
                        [
                            new BABYLON.Sprite2D(upgradeWindow,
                            {
                                id: "mainRect", marginAlignment: "h: center, v:center"
                            }),

                            new BABYLON.Lines2D([new BABYLON.Vector2(460, 620), new BABYLON.Vector2(520, 620)], {
                                id: "back",
                                border: "#FFFFFFFF", borderThickness: 2
                            }),

                            new BABYLON.Lines2D([new BABYLON.Vector2(1080, 473), new BABYLON.Vector2(1210, 473)], {
                                id: "upgrade1",
                                border: "#98181fFF", borderThickness: 2
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(1080, 373), new BABYLON.Vector2(1210, 373)], {
                                id: "upgrade2",
                                border: "#98181fFF", borderThickness: 2
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(1080, 273), new BABYLON.Vector2(1210, 273)], {
                                id: "upgrade3",
                                border: "#98181fFF", borderThickness: 2
                            }),

                            new BABYLON.Sprite2D(upgradeButton,
                            {
                                id: "mainRect1", x: 1080, y: 485
                            }),
                            new BABYLON.Sprite2D(upgradeButton,
                            {
                                id: "mainRect2", x: 1080, y: 385
                            }),
                            new BABYLON.Sprite2D(upgradeButton,
                            {
                                id: "mainRect3", x: 1080, y: 285
                            })
                        ]
                    }),
                    new BABYLON.Group2D(
                    {
                        id: "nekaj",
                        children:
                        [
                            new BABYLON.Rectangle2D(
                            {
                                id: "mainRect", x: 0, y: 0, width: 300, height: 80,
                                children:
                                [
                                    new BABYLON.Sprite2D(lol2,
                                    {
                                        id: "mainRect2", x: 0, y: 0,
                                    }),
                                    new BABYLON.Text2D(points+"  ",
                                    {
                                        id: "text",
                                        marginAlignment: "h: right, v:center",
                                        fontName: "20pt Arial"
                                    })
                                ]
                            }),
                            new BABYLON.Rectangle2D(
                            {
                                id: "mainRect2", x: 0, y: engine.getRenderHeight()-60, width: 300, height: 80,
                                children:
                                [
                                    new BABYLON.Sprite2D(lol,
                                    {
                                        id: "mainRect", marginAlignment: "h: center, v:center"
                                    }),
                                    new BABYLON.Text2D(enemies+"  ",
                                    {
                                        id: "text2",
                                        marginAlignment: "h: right, v: left",
                                        fontName: "20pt Arial"
                                    })
                                ]
                            }),
                            new BABYLON.Rectangle2D(
                            {
                                id: "mainRect3", x: engine.getRenderWidth()/2 - 140, y: engine.getRenderHeight()-60, width: 300, height: 80,
                                children:
                                [
                                    new BABYLON.Sprite2D(lvl,
                                    {
                                        id: "mainRec3t", marginAlignment: "h: center, v:center"
                                    }),
                                    new BABYLON.Text2D("level  ",
                                    {
                                        id: "text23",
                                        marginAlignment: "h: right, v: center",
                                        fontName: "20pt Arial"
                                    })
                                ]
                            }),

                        ]
                    }),
                    new BABYLON.Group2D(
                    {
                        id: "nekaj"
                    })
                ]
            });

            menuCanvas.children[0].children[1].levelVisible = false;
            menuCanvas.children[0].children[2].levelVisible = false;

            menuCanvas.children[1].levelVisible = false;
            menuCanvas.children[1].children[1].levelVisible = false;
            menuCanvas.children[1].children[2].levelVisible = false;
            menuCanvas.children[1].children[3].levelVisible = false;
            menuCanvas.children[1].children[4].levelVisible = false;

            menuCanvas.children[2].levelVisible = false;

            activeScreen = "main";
        }




        function handleClick(event)
        {
            if(gameActive)
                return;

            var x = event.clientX -22;
            var y = event.clientY -155;

            if(activeScreen == "main")
            {
                if(x > 1040 && y < 400 && y > 300 && x < 1220 )
                {
                    gameActive = true;
                    //changed = true;
                    activeScreen = "play";

                    menuCanvas.children[0].levelVisible = false;
                    menuCanvas.children[1].levelVisible = false;
                    menuCanvas.children[2].levelVisible = true;
                }
                else if(x > 440 && y < 500 && y > 400 && x < 760 )
                {
                    menuCanvas.children[0].levelVisible = false;
                    menuCanvas.children[1].levelVisible = true;
                    activeScreen = "upgrades";

                    if(p1.upgrades > 0)
                    {
                        menuCanvas.children[1].children[5].levelVisible = true;
                        menuCanvas.children[1].children[6].levelVisible = true;
                        menuCanvas.children[1].children[7].levelVisible = true;
                    }
                    else
                    {
                        menuCanvas.children[1].children[5].levelVisible = false;
                        menuCanvas.children[1].children[6].levelVisible = false;
                        menuCanvas.children[1].children[7].levelVisible = false;
                    }
                }
            }
            else if(activeScreen == "upgrades")
            {
                if(x > 440 && y < 140 && y > 70 && x < 510 )
                {
                    menuCanvas.children[1].levelVisible = false;
                    menuCanvas.children[0].levelVisible = true;
                    activeScreen = "main";
                }
                else if(x > 1080 && x < 1210 && y > 235 && y < 275 && p1.upgrades > 0)
                {
                    p1.upgrades--;
                    p1.upgradePrimary();
                }
                else if(x > 1080 && x < 1210 && y > 335 && y < 375 && p1.upgrades > 0)
                {
                    p1.upgrades--;
                    p1.upgradeSecundary();
                }
                else if(x > 1080 && x < 1210 && y > 435 && y < 475 && p1.upgrades > 0)
                {
                    p1.upgrades--;
                    p1.upgradeHealth();
                }
                else
                {
                    menuCanvas.children[1].children[1].levelVisible = false;
                    menuCanvas.children[1].children[2].levelVisible = false;
                    menuCanvas.children[1].children[3].levelVisible = false;
                    menuCanvas.children[1].children[4].levelVisible = false;
                }

                if(p1.upgrades > 0)
                {
                    menuCanvas.children[1].children[5].levelVisible = true;
                    menuCanvas.children[1].children[6].levelVisible = true;
                    menuCanvas.children[1].children[7].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[1].children[5].levelVisible = false;
                    menuCanvas.children[1].children[6].levelVisible = false;
                    menuCanvas.children[1].children[7].levelVisible = false;
                }

            }

        }

        function handleMove(event)
        {
            if(gameActive)
                return;


            var x = event.clientX -22;
            var y = event.clientY -155;

            if(activeScreen == "main")
            {
                if(x > 1040 && y < 400 && y > 300 && x < 1220 )
                {
                    menuCanvas.children[0].children[1].levelVisible = true;
                }
                else if(x > 440 && y < 500 && y > 400 && x < 760 )
                {
                    menuCanvas.children[0].children[2].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[0].children[1].levelVisible = false;
                    menuCanvas.children[0].children[2].levelVisible = false;
                }
            }
            else if(activeScreen == "upgrades")
            {
                if(x > 440 && y < 140 && y > 70 && x < 510 )
                {
                    menuCanvas.children[1].children[1].levelVisible = true;
                }
                else if(x > 1080 && x < 1210 && y > 235 && y < 275 && p1.upgrades > 0)
                {
                    menuCanvas.children[1].children[2].levelVisible = true;
                }
                else if(x > 1080 && x < 1210 && y > 335 && y < 375 && p1.upgrades > 0)
                {
                    menuCanvas.children[1].children[3].levelVisible = true;
                }
                else if(x > 1080 && x < 1210 && y > 435 && y < 475 && p1.upgrades > 0)
                {
                    menuCanvas.children[1].children[4].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[1].children[1].levelVisible = false;
                    menuCanvas.children[1].children[2].levelVisible = false;
                    menuCanvas.children[1].children[3].levelVisible = false;
                    menuCanvas.children[1].children[4].levelVisible = false;
                }

                if(p1.upgrades > 0)
                {
                    menuCanvas.children[1].children[5].levelVisible = true;
                    menuCanvas.children[1].children[6].levelVisible = true;
                    menuCanvas.children[1].children[7].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[1].children[5].levelVisible = false;
                    menuCanvas.children[1].children[6].levelVisible = false;
                    menuCanvas.children[1].children[7].levelVisible = false;
                }
            }
            return;
        }

        var menuCanvas;
        var mine;

        var createScene = function()
        {
            var scene = new BABYLON.Scene(engine);



                //var l = new BABYLON.Layer("la", "assets/test2.jpg", scene,{scale: new BABYLON.Vector2(640, 480), offset: new BABYLON.Vector2(640, 480)});
                //l.render();


            var gravityVector = new BABYLON.Vector3(0,-9.81, 0);
            var physicsPlugin = new BABYLON.CannonJSPlugin();

            scene.enablePhysics(gravityVector, physicsPlugin);

            var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);


            BABYLON.SceneLoader.ImportMesh("", "", "tank.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat0", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/Main Body.png", scene);

                tankMaterials[1] = new BABYLON.StandardMaterial("Mat1", scene);
                tankMaterials[1].diffuseTexture = new BABYLON.Texture("assets/player/Main Body 2.png", scene);

                tankMaterials[2] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[2].diffuseTexture = new BABYLON.Texture("assets/player/Turret.png", scene);

                tankMaterials[3] = new BABYLON.StandardMaterial("Mat3", scene);
                tankMaterials[3].diffuseTexture = new BABYLON.Texture("assets/player/Gun.png", scene);


                for(i = 0; i < tank.length; i++)
                {
                    tank[i].material = tankMaterials[i];
                }


                p1 = new Player("player", BABYLON.Mesh.MergeMeshes(tank));
                bots.push(new Player("bot 0", p1.player.clone()));
                bots.push(new Player("bot 1", p1.player.clone()));
                bots.push(new Player("bot 2", p1.player.clone()));

                FPCamera.lockedTarget = p1.player;
                scene.activeCamera = FPCamera;

                p1.createPlayer(scene);

                createBots(scene);


            });


            BABYLON.SceneLoader.ImportMesh("", "", "box.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat0", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/box/WoodPlanks_Color.jpg", scene);

                tank[0].material = tankMaterials[0];

                woodenBox = BABYLON.Mesh.MergeMeshes(tank);

            });

            BABYLON.SceneLoader.ImportMesh("", "", "mine.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/mine.png", scene);

                tank[0].material = tankMaterials[0];

                mine = BABYLON.Mesh.MergeMeshes(tank);

                mine.scaling(new BABYLON.Vector3(-100, 1, 1));
                mine.rotate(BABYLON.Axis.Z, -0.05, BABYLON.Space.LOCAL);


            });

            var controlCamera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 150, 45), scene);
            controlCamera.setTarget(BABYLON.Vector3.Zero());
            //controlCamera.attachControl(canvas, false);

            var FPCamera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 15, 45), scene);
            FPCamera.radius = 30;
            FPCamera.heightOffset = 10; //10
            FPCamera.rotationOffset = 0;

            //controlCamera.attachControl(canvas, false);
            //scene.activeCamera = controlCamera;


            //scene.activeCamera = controlCamera;


            var skybox = BABYLON.Mesh.CreateBox("skyBox", 400.0, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/skybox/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;



            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("assets/mesh.png", scene);


            ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "assets/mesh.png", 200, 200, 50, 0, 40, scene, false, function ()
            {
                ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0}, scene);
                ground.material = groundMaterial;

            });


            /*
            var ground = BABYLON.Mesh.CreateGround('ground1', 60, 60, 2, scene);
            ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
            ground.material = groundMaterial;
            */

            window.addEventListener("keydown", function(evt)
            {

                if(gameActive)
                {

                    switch(evt.keyCode)
                    {
                        case 65:        p1.player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);
                                        //p1.player.updatePhysicsBodyPosition();
                                        //p1.player.rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(0, -0.05, 0);
                                        //p1.player.rotation.y -= 0.1;

                        //A
                                        break;

                        case 87:        p1.player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);
                        //W
                                        /*
                                        var rotz = p1.player.rotationQuaternion.toEulerAngles();
                                        var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / p1.speed, p1.player.position.y, parseFloat(Math.cos(rotz.y)) / p1.speed);
                                        p1.player.applyImpulse(backwards.negate(), p1.player);
                                        */
                                        break;


                        case 68:
                                        //p1.player.rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(0, 0.05, 0);
                                        p1.player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);
                                        //p1.player.rotation.y += 0.1;
                                        //p1.player.rotation = new BABYLON.Vector3(0, 1, 0);
                                        break;

                        case 83:        /*
                                        var up_local = new BABYLON.Vector3(0, 0, 0.5);
                                        var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);
                                        player.applyImpulse(up_global, player.position);
                                        player.setLinearVelocity.scaleEqual(0.5);
                                        break;      //S     */

                                        p1.player.translate(BABYLON.Axis.Z, 0.5, BABYLON.Space.LOCAL);
                                        break;

                        case 32:        p1.shoot(scene);


                                        break;      //SPACE

                        case 86:
                                        cam = ++cam % 3;
                                        switch(cam)
                                        {
                                                case 0:     scene.activeCamera = FPCamera;
                                                            FPCamera.lockedTarget = p1.player;
                                                            FPCamera.radius = 30;
                                                            FPCamera.heightOffset = 10;
                                                            break;

                                                case 1:     scene.activeCamera = FPCamera;
                                                            FPCamera.lockedTarget = p1.player;
                                                            FPCamera.radius = 30;
                                                            FPCamera.heightOffset = 80;
                                                            break;

                                                case 2:     scene.activeCamera = controlCamera;
                                                            //controlCamera.attachControl(canvas, false);
                                                            break;
                                        }
                                        break;
                        case 88:
                                        if(p1.mines.length < p1.mineLimit)
                                            p1.plant();
                                        break;
                                        //V (VIEW)
                    }
                }

            }, false);


            create2D(scene);

            return scene;

    }


    var scene = createScene();
    var a = 0;
    engine.runRenderLoop(function()
    {
        if(gameActive && scene.isReady())
        {
            //move();
            check(scene);
            menuCanvas.children[2].children[0].children[1].text = points+"  ";
            menuCanvas.children[2].children[1].children[1].text = enemies+"  ";

            //menuCanvas.children[3].children[0].children[0].children[0].text = "HP: "+p1.hp;
            if(a == 0)
            {
                menuCanvas.children[3].children[0].children[0].levelVisible = true;
                menuCanvas.children[3].children[1].children[0].levelVisible = true;
                menuCanvas.children[3].children[2].children[0].levelVisible = true;
                menuCanvas.children[3].children[3].children[0].levelVisible = true;
                a++;
            }

            if(Math.floor((Math.random() * 128)) == 11)
            {
                createUpgradeBox();
            }

        }
        scene.render();
    });



    window.addEventListener('resize', function() {
        engine.resize();
    });

    </script>
</body>
</html>
