<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>BattleTanks - Iron War</title>
    <!-- link to the last version of babylon -->
    <script src="scripts\babylon.custom.js"></script>
    <script src="scripts\babylon.objFileLoader.js"></script>
    <link rel="stylesheet" href="style\style.css">

</head>
<body>
    <canvas id="renderCanvas"></canvas>


    <script>

        window.addEventListener('DOMContentLoaded', function()
        {
            // your code here

        });

        //var player;
        var tank = [];
        var bots = [];
        var shoots = [];
        var p1;
        var ctx;


        function Player(mesh)
        {
            this.player = mesh;
            this.HP = 100;
            this.power = 1;
            this.speed = 1;

            this.createPlayer=function(scene)
            {
                this.player.position = new BABYLON.Vector3(-20, 15, 10);
                this.player.physicsImpostor = new BABYLON.PhysicsImpostor(this.player, BABYLON.PhysicsEngine.BoxImpostor, { mass: 1000, friction: 0.01, restitution: 0 }, scene);
                this.player.showBoundingBox = true;
            }
        }


        function createBots(number, scene)
        {
            for(i = 0; i < number; i++)
            {
                bots.push(p1.player.clone());
                bots[bots.length - 1].position =  new BABYLON.Vector3(-5*i, 20, 10*i-10);
                bots[bots.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(bots[bots.length - 1], BABYLON.PhysicsEngine.BoxImpostor, { mass: 1000, friction: 0.01, restitution: 0 }, scene);
            }
        }

        function shoot(scene, direction)
        {
            shoots.push(BABYLON.Mesh.CreateSphere("sphere", 10.0, 0.1, scene));
            var predMano = new BABYLON.Vector3(p1.player.position.x, p1.player.position.y, p1.player.position.z - 10);
            var left_global = BABYLON.Vector3.TransformCoordinates(predMano, p1.player.getWorldMatrix());
            shoots[shoots.length - 1].position = left_global;

            shoots[shoots.length - 1].setPhysicsState(BABYLON.PhysicsEngine.SphereImpostor, { mass: 1, friction: 1, restitution: 0 });
            shoots[shoots.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(shoots[shoots.length - 1], BABYLON.PhysicsImpostor.SphereImpostor, { mass: 1, restitution: 0.9 }, scene);
            shoots[shoots.length - 1].applyImpulse(direction, shoots[shoots.length - 1].position);
            //shoots[shoots.length - 1].setLinearVelocity.scaleEqual(0.9);
        }



        var canvas = document.getElementById('renderCanvas');

        var engine = new BABYLON.Engine(canvas, true);




        var createScene = function()
        {
            var scene = new BABYLON.Scene(engine);



            var gravityVector = new BABYLON.Vector3(0,-9.81, 0);
            var physicsPlugin = new BABYLON.CannonJSPlugin();

            scene.enablePhysics(gravityVector, physicsPlugin);

            //canvas = document.getElementById('renderCanvas');

            //label1Texture.drawText("text", 512, 512, "8pt Arial", "#40C040FF", "#40C040FF");
            //label1Texture.update();

            //var playgroundSize = 100;
// Background






        //backgroundTexture.drawText("Eternalcoding", null, 80, "bold 70px Segoe UI", "white", "#555555");
        //backgroundTexture.drawText("- browsers statistics -", null, 250, "35px Segoe UI", "white", null);




            var controlCamera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 15, 45), scene);

            controlCamera.setTarget(BABYLON.Vector3.Zero());

    // attach the camera to the canvas
            //controlCamera.attachControl(canvas, false);
            /*var FPCamera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(-40, 15, 50), scene);
            FPCamera.radius = 30;
            FPCamera.heightOffset = 10;
            FPCamera.rotationOffset = 0;
            */
scene.activeCamera = controlCamera;
            var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);


            BABYLON.SceneLoader.ImportMesh("", "", "tank.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat0", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/Main Body.png", scene);

                tankMaterials[1] = new BABYLON.StandardMaterial("Mat1", scene);
                tankMaterials[1].diffuseTexture = new BABYLON.Texture("assets/player/Main Body 2.png", scene);

                tankMaterials[2] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[2].diffuseTexture = new BABYLON.Texture("assets/player/Turret.png", scene);

                tankMaterials[3] = new BABYLON.StandardMaterial("Mat3", scene);
                tankMaterials[3].diffuseTexture = new BABYLON.Texture("assets/player/Gun.png", scene);


                for(i = 0; i < tank.length; i++)
                {
                    tank[i].material = tankMaterials[i];
                }


                p1 = new Player(BABYLON.Mesh.MergeMeshes(tank));
                //FPCamera.target = p1.player;
                p1.createPlayer(scene);

                createBots(3, scene);


            });

            /*
            var skybox = BABYLON.Mesh.CreateBox("skyBox", 400.0, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/skybox/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;
            */


            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("assets/mesh.png", scene);

            /*
            var ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "assets/mesh.png", 200, 200, 50, 0, 40, scene, false, function ()
            {
                //ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
                ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0}, scene);
                ground.material = groundMaterial;

            });
            */


            var ground = BABYLON.Mesh.CreateGround('ground1', 60, 60, 2, scene);
            ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
            ground.material = groundMaterial;



            try
            {
                //alert("try");
                for(j = 0; j < bots.length; j++)
                {
                    //alert("try");
                    p1.player.physicsImpostor.registerOnPhysicsCollide(bots[j].physicsImpostor, function(main, collided)
                    {
                        main.object.showBoundingBox = false;
                            //main.object.material.diffuseColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
                            //var sphere = BABYLON.Mesh.CreateSphere("sphere1", 8, 2, scene);
                            //sphere.position = player.position;

                        p1.HP -= 10;
                        alert(p1.HP);
                        if(p1.HP < 0)
                            p1.player.dispose();
                    });
                }
            }
            catch(e)
            {}


        	window.addEventListener("keydown", function(evt)
            {
                switch(evt.keyCode)
                {
                    case 65:        p1.player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);
                    //A
                                    break;

                    case 87:        p1.player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);
                    //W

                                    //tank[0].updatePhysicsBodyPosition();

                                    //var left_global = BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(0.0,0.0,1.0), player.getWorldMatrix());
                                    //var tank_global = BABYLON.Vector3.TransformCoordinates(tank[0].position, tank[0].getWorldMatrix());
                                    //for(i = 0; i < tank.length; i++)
                                    //{
                                    //player.applyImpulse(left_global, player.getAbsolutePosition());
                                        //tank[0].moveWithCollisions(left_global);

                                    break;


                    case 68:        p1.player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);

                                    break;

                    case 83:        /*
                                    var up_local = new BABYLON.Vector3(0, 0, 0.5);
                                    var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);
                                    player.applyImpulse(up_global, player.position);
                                    player.setLinearVelocity.scaleEqual(0.5);
                                    break;      //S     */

                                    p1.player.translate(BABYLON.Axis.Z, 0.5, BABYLON.Space.LOCAL);
                                    break;

                    case 32:        var up_local = new BABYLON.Vector3(0, 0, -20);
                                    //var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);
                                    shoot(scene, up_local);

                                    break;      //SPACE

                    case 86:       // scene.activeCamera = controlCamera;       break;
                                    start1();
                                    break;//V (VIEW)
                }
        	}, false);

            /*
            var backgroundTexture = new BABYLON.DynamicTexture("dynamic texture", {width:1024, height:512}, scene, true);
            var context = backgroundTexture.getContext();
            context.fillRect(10, 10, 55, 50);
            backgroundTexture.update();
            */


            var d = 50;
            var cubes = new Array();
            for (var i = 0; i < 360; i += 20) {
                var r = BABYLON.Tools.ToRadians(i);
                var b = BABYLON.Mesh.CreateBox("Box #" + i / 20, 5, scene, false);
                b.position.x = Math.cos(r) * d;
                b.position.z = Math.sin(r) * d;
                cubes.push(b);
            }
            var canvas = new BABYLON.ScreenSpaceCanvas2D(scene, {
                id: "ScreenCanvas"
            });
            i = 0;
            for (var _i = 0, cubes_1 = cubes; _i < cubes_1.length; _i++) {
                var cube = cubes_1[_i];
                new BABYLON.Group2D({
                    parent: canvas, id: "GroupTag #" + i, width: 80, height: 40, trackNode: cube, origin: BABYLON.Vector2.Zero(),
                    children: [
                        new BABYLON.Rectangle2D({ id: "firstRect", width: 80, height: 26, x: 0, y: 0, origin: BABYLON.Vector2.Zero(), border: "#FFFFFFFF", fill: "#808080FF", children: [
                                new BABYLON.Text2D(cube.name, { marginAlignment: "h: center, v:center", fontName: "bold 12px Arial" })
                            ]
                        })
                    ]
                });
                ++i;
            }

            return scene;
    }

    /*window.addEventListener("keydown", function(evt)
    {
        switch(evt.keyCode)
        {
            case 65:*/


                        /*
                        break;

            default:    start1();
        }
    });*/

    var scene = createScene();

    engine.runRenderLoop(function() {

        scene.render();

    });

    window.addEventListener('resize', function() {
        engine.resize();
    });

    </script>
</body>
</html>
