<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>BattleTanks - Iron War</title>
    <!-- link to the last version of babylon -->
    <script src="scripts\babylon.custom.js"></script>
    <script src="scripts\babylon.objFileLoader.js"></script>
    <link rel="stylesheet" href="style\style.css">

</head>
<body>
    <canvas id="renderCanvas"></canvas>


    <script>

        window.addEventListener('DOMContentLoaded', function()
        {
            // your code here

        });

        //var player;
        var tank = [];
        var bots = [];
        var shoots = [];


        function createPlayer(scene)
        {
            //player = BABYLON.Mesh.CreateBox("Player", 1.0, scene);
            for(i = 0; i < tank.length; i++)
            {
                tank[i].position = new BABYLON.Vector3(-4, 150, 0);
                tank[i].setPhysicsState(BABYLON.PhysicsEngine.BoxImpostor, { mass: 10, friction: 0.01, restitution: 0 });
            }
        }

        function createBots(number, scene)
        {
            for(i = 0; i < number; i++)
            {
                bots.push(BABYLON.Mesh.CreateBox("Bot", 1.0, scene));
                bots[bots.length - 1].position =  new BABYLON.Vector3(-5, 15, i);
                bots[bots.length - 1].setPhysicsState(BABYLON.PhysicsEngine.SphereImpostor, { mass: 1, friction: 0.5, restitution: 0 });
            }
        }

        function shoot(scene, direction)
        {
            shoots.push(BABYLON.Mesh.CreateSphere("sphere", 10.0, 0.1, scene));
            shoots[shoots.length - 1].position = new BABYLON.Vector3(tank[0].position.x, tank[0].position.y, tank[0].position.z - 0.1);
            shoots[shoots.length - 1].setPhysicsState(BABYLON.PhysicsEngine.SphereImpostor, { mass: 1, friction: 1, restitution: 0 });
            //shoots[shoots.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(shoots[shoots.length - 1], BABYLON.PhysicsImpostor.SphereImpostor, { mass: 1, restitution: 0.9 }, scene);
            shoots[shoots.length - 1].applyImpulse(direction, shoots[shoots.length - 1].position);
            shoots[shoots.length - 1].setLinearVelocity.scaleEqual(0.9);
        }

        function changeCamera(scene, controlCamera)
        {
            scene.activeCamera = controlCamera;
        }


    	var canvas = document.getElementById('renderCanvas');
    	var engine = new BABYLON.Engine(canvas, true);

        var createScene = function()
        {
            // create a basic BJS Scene object
            var scene = new BABYLON.Scene(engine);

            var gravityVector = new BABYLON.Vector3(0,-4.81, 0);
            var physicsPlugin = new BABYLON.CannonJSPlugin();
            scene.enablePhysics(gravityVector, physicsPlugin);

            var controlCamera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 15, 45), scene);
            var FPCamera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 15, 45), scene);

            scene.activeCamera = FPCamera;

            // create a basic light, aiming 0,1,0 - meaning, to the sky
            var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);

        	// gradnja kocke
            BABYLON.SceneLoader.ImportMesh("", "", "tank.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat0", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/Main Body.png", scene);

                tankMaterials[1] = new BABYLON.StandardMaterial("Mat1", scene);
                tankMaterials[1].diffuseTexture = new BABYLON.Texture("assets/player/Main Body 2.png", scene);

                tankMaterials[2] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[2].diffuseTexture = new BABYLON.Texture("assets/player/Turret.png", scene);

                tankMaterials[3] = new BABYLON.StandardMaterial("Mat3", scene);
                tankMaterials[3].diffuseTexture = new BABYLON.Texture("assets/player/Gun.png", scene);


                for(i = 0; i < tank.length; i++)
                {
                    tank[i].material = tankMaterials[i];
                }

                FPCamera.target = tank[0];

                createPlayer(scene);
            });


            //createBots(3, scene);
            player = BABYLON.Mesh.CreateBox("Player", 1.0, scene);

            //camera.applyGravity = true;

            // create a built-in "ground" shape; its constructor takes the same 5 params as the sphere's one
            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("assets/mesh.png", scene);


            var ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "assets/mesh.png", 200, 200, 50, 0, 40, scene, false, function ()
            {
                ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
                ground.material = groundMaterial;
            });

            /*
            var ground = BABYLON.Mesh.CreateGround('ground1', 60, 60, 2, scene);
            ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
            ground.material = groundMaterial;
            */

        	window.addEventListener("keydown", function(evt)
            {
                switch(evt.keyCode)
                {
                    case 65:

                                    for(i = 0; i < tank.length; i++)
                                    {
                                        tank[i].rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);
                                    }
                                    break;

                    case 87:        //player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);

                                    tank[0].computeWorldMatrix();
                                    var matrix = tank[0].getWorldMatrix();
                                    var up_local = new BABYLON.Vector3(0, 0, -0.5);
                                    var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);


                                    for(i = 0; i < tank.length; i++)
                                    {
                                        tank[i].applyImpulse(up_global, tank[i].position);
                                        //tank[i].moveWithCollisions(up_global);
                                    }
                                    break;


                    case 68:        for(i = 0; i < tank.length; i++)
                                    {
                                        tank[i].rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);
                                    }
                                    break;

                    case 83:        /*
                                    var up_local = new BABYLON.Vector3(0, 0, 0.5);
                                    var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);
                                    player.applyImpulse(up_global, player.position);
                                    player.setLinearVelocity.scaleEqual(0.5);
                                    break;      //S     */
                                    break;

                    case 32:        //var up_local = new BABYLON.Vector3(0, 0, -20);
                                    //var up_global = BABYLON.Vector3.TransformCoordinates(up_local, matrix);
                                    //shoot(scene, up_global);

                                    break;      //SPACE

                    case 86:        //changeCamera(scene, controlCamera);          break;      //V (VIEW)
                }
        	}, false);



            return scene;
    }

    var scene = createScene();
    engine.runRenderLoop(function() {

        scene.render();

    });
    window.addEventListener('resize', function() {
        engine.resize();
    });

    </script>
</body>
</html>
