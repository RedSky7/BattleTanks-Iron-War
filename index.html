<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>BattleTanks - Iron War</title>
    <!-- link to the last version of babylon -->
    <script src="scripts\babylon.custom.js"></script>
    <script src="scripts\babylon.objFileLoader.js"></script>
    <link rel="stylesheet" href="style\style.css">

</head>
<body>
    <canvas id="renderCanvas" onclick="handleClick(event)" onmousemove="handleMove(event)"></canvas>


    <script>

        window.addEventListener('DOMContentLoaded', function()
        {
            // your code here

        });

        //var player;
        var tank = [];
        var bots = [];
        var p1 = new Player("player", " k");
        var cam = 0;

        var points = 0;
        var ground;

        var gameActive = false;

        var enemies = 3;

        var level = 1;
        var levelUp = false;

        var upgrades = 1;

        var canShoot = false;
        var canShootFun = setInterval(change, 400);

        var keys = [];

        var FPCamera, controlCamera;




        function change()
        {
            canShoot = true;
        }

        function resetScene(caseLevelUp)
        {

            if(!caseLevelUp)
            {
                level = 1;
                points = 0;
            }

            a = 0;
            tank = [];
            bots = [];
            p1 = new Player("player", " k");
            cam = 0;
            scene = createScene();
        }



        function handleKeys()
        {
            if(gameActive && p1.player != null)
            {

                if(keys[65])
                    p1.player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);

                //W
                if(keys[87])
                    p1.player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);

                //D
                if(keys[68])
                    p1.player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);

                //S
                if(keys[83])
                    p1.player.translate(BABYLON.Axis.Z, 0.5, BABYLON.Space.LOCAL);

                //SPACE
                if(keys[32] && canShoot)
                {
                    p1.shoot(scene);
                    canShoot = false;
                }

                //V- VIEW

                //X- MINE

            }
        }

        function setUpLevel1()
        {
            enemies = 3;
            var temp = p1.player.clone();
            bots = [];
            bots.push(new Player("bot 1", temp.clone()));
            bots.push(new Player("bot 2", temp.clone()));
            bots.push(new Player("bot 3", temp.clone()));

            bots[0].mineLimit = 3;
            bots[1].mineLimit = 2;
            bots[2].mineLimit = 3;

        }

        function setUpLevel2()
        {
            enemies = 5;

            bots.push(new Player("bot 0", p1.player.clone()));
            bots[bots.length - 1].cannonDamage = 10;
            bots.push(new Player("bot 1", p1.player.clone()));
            bots.push(new Player("bot 2", p1.player.clone()));
            bots.push(new Player("bot 3", p1.player.clone()));
            bots[bots.length - 1].cannonDamage = 10;
            bots.push(new Player("bot 4", p1.player.clone()));
        }

        function setUpLevel3()
        {
            enemies = 5;

            bots.push(new Player("bot 0", p1.player.clone()));
            bots[bots.length - 1].cannonDamage = 10;
            bots.push(new Player("bot 1", p1.player.clone()));
            bots.push(new Player("bot 2", p1.player.clone()));
            bots.push(new Player("bot 3", p1.player.clone()));
            bots[bots.length - 1].mineDamage = 50;
            bots.push(new Player("bot 4", p1.player.clone()));
            bots[bots.length - 1].cannonDamage = 30;
            return;
        }

        function setUpLevel4()
        {
            return;
        }

        function Player(name, mesh)
        {
            this.name = name;
            this.player = mesh;

                this.hp = 100;
                this.maxHP = 100;

                this.cannonDamage = 5;

                this.mineDamage = 5;

            this.speed = 0.008;
            this.gravity = 0.15;

            this.bullets = [];

            this.mineLimit = 1;
            this.mines = [];

            this.tempL = 10;
            this.tempD = 10;
            this.override = 0;


            this.createPlayer=function(scene)
            {
                this.player.position = new BABYLON.Vector3(-20, 25, 30);
                this.player.physicsImpostor = new BABYLON.PhysicsImpostor(this.player, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.91, restitution: 0 }, scene);

                new BABYLON.Group2D(
                {
                    parent: menuCanvas.children[3], id: "Player", width: 80, height: 40, trackNode: p1.player, origin: BABYLON.Vector2.Zero(),
                    children:
                    [
                        new BABYLON.Rectangle2D(
                        {
                            id: "firstPlayer", width: 60, height: 15, x: -30, y: 50, origin: BABYLON.Vector2.Zero(), border: "#FFFFFFFF", fill: "#40C040CC"
                        })
                    ]
                });
                menuCanvas.children[3].children[0].children[0].levelVisible = false;
            }

            this.shoot=function(scene)
            {
                this.bullets.push(BABYLON.Mesh.CreateSphere("sphere", 10.0, 0.2, scene));

                var rotz = this.player.rotationQuaternion.toEulerAngles();
                var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / this.speed, rotz.x*10 +2, parseFloat(Math.cos(rotz.y)) / this.speed);

                this.bullets[this.bullets.length - 1].position = new BABYLON.Vector3(this.player.position.x + (parseFloat(Math.sin(rotz.y)) / 0.2)*(-1), this.player.position.y + rotz.x*10 +2, this.player.position.z + (parseFloat(Math.cos(rotz.y)) / 0.2)*(-1));

                this.bullets[this.bullets.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(this.bullets[this.bullets.length - 1], BABYLON.PhysicsImpostor.SphereImpostor, { mass: 1, restitution: 0 }, scene);
                this.bullets[this.bullets.length - 1].applyImpulse(backwards.negate(), this.bullets[this.bullets.length - 1].position);
            }

            this.plant=function(scene)
            {
                this.mines.push(mine.clone());

                this.mines[this.mines.length -1].scaling = new BABYLON.Vector3(0.15, 0.15, 0.15);
                this.mines[this.mines.length -1].rotate(BABYLON.Axis.X, 1, BABYLON.Space.LOCAL);

                var rotz = this.player.rotationQuaternion.toEulerAngles();
                var backwards = new BABYLON.Vector3(parseFloat(Math.sin(rotz.y)) / this.speed , rotz.x*10 +2, parseFloat(Math.cos(rotz.y)) / this.speed);

                this.mines[this.mines.length - 1].position = new BABYLON.Vector3(this.player.position.x + (parseFloat(Math.sin(rotz.y)) / 0.15), this.player.position.y + rotz.x*10 +2 , this.player.position.z + (parseFloat(Math.cos(rotz.y)) / 0.15));
                this.mines[this.mines.length - 1].physicsImpostor = new BABYLON.PhysicsImpostor(this.mines[this.mines.length - 1], BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, restitution: 0 }, scene);
            }


            this.upgradePrimary=function()
            {
                this.cannonDamage += 5;
                menuCanvas.children[1].children[8].text = this.cannonDamage+" ";
            }

            this.upgradeSecondary=function()
            {
                this.mineDamage += 5;
                this.mineLimit++;
                menuCanvas.children[1].children[9].text = this.mineDamage+" ";
            }

            this.upgradeHealth=function()
            {
                this.hp += 10;
                this.maxHP += 10;
                menuCanvas.children[1].children[10].text = this.hp+" ";
            }
        }


        var groundHit;
        var rem = [];

        function checkForFall(object)
        {
            if(object == null)
                return;

            if(object.player.position.x > 90)
                object.player.position.x = 80;
            else if(object.player.position.x < -90)
                object.player.position.x = -80;
            if(object.player.position.z > 90)
                object.player.position.z = 80;
            else if(object.player.position.z < -90)
                object.player.position.z = -80;
        }


        function checkForHit(parent, weapon, wIndex, collided, cIndex, weaponType)
        {
            if(bots[j] == null)
                return false;

            if(weapon[wIndex].intersectsMesh(collided[cIndex].player, true))
            {
                switch(weaponType)
                {
                    case "cannonDamage":    collided[cIndex].hp -= parent.cannonDamage; break;
                    case "mineDamage":      collided[cIndex].hp -= parent.mineDamage;   break;
                }

                points++;
                weapon[wIndex].dispose();
                weapon.splice(wIndex, 1);

                var length = menuCanvas.children[3].children[cIndex+1].children[0].width;

                if( length < 35 && length > 25 )
                    menuCanvas.children[3].children[cIndex+1].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                else if(length < 25)
                    menuCanvas.children[3].children[cIndex+1].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                menuCanvas.children[3].children[cIndex+1].children[0].width = Math.floor(60 * (collided[cIndex].hp / 100));

                return true;
            }
            return false
        }


        function check(scene)
        {

            checkForFall(p1);
            for(i = 0; i < bots.length; i++)
                checkForFall(bots[i]);


            groundHit = false;

            for(i = 0; i < p1.bullets.length; i++)
            {
                if(p1.bullets[i].position.x > 90 || p1.bullets[i].position.x < -90 || p1.bullets[i].position.z > 90 || p1.bullets[i].position.z < -90)
                {
                    p1.bullets[i].dispose();
                    p1.bullets.splice(i, 1);
                    i--;
                    break;
                }

                p1.bullets[i].physicsImpostor.registerOnPhysicsCollide(ground.physicsImpostor, function(main, collided)
                {
                    if(groundHit)
                        return;

                    for(j = 0; j < p1.bullets.length; j++)
                        if(main.object == p1.bullets[j])
                        {
                             rem.push(j);
                        }

                    groundHit=true;
                    return;
                });

                for(j = 0; j < bots.length; j++)
                {
                    if(checkForHit(p1, p1.bullets, i, bots, j, "cannonDamage"))
                    {
                        i--;
                        break;
                    }
                }
            }

            for(i = 0; i < p1.mines.length; i++)
            {
                for(j = 0; j < bots.length; j++)
                {
                    if(checkForHit(p1, p1.mines, i, bots, j, "mineDamage"))
                    {
                        i--;
                        break;
                    }
                }

                if(p1.mines[i].intersectsMesh(p1.player, true))
                {
                    p1.hp -= p1.mineDamage;
                    points -= 20;

                    p1.mines[i].dispose();
                    p1.mines.splice(i, 1);
                    i--;

                    var length = menuCanvas.children[3].children[0].children[0].width;

                    if( length < 35 && length > 25 )
                        menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                    else if(length < 25)
                        menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                    menuCanvas.children[3].children[0].children[0].width = Math.floor(60 * (p1.hp / p1.maxHP));

                    break;
                }
            }

            for(i = 0; i < bots.length; i++)
            {
                if(bots[i] == null)
                    continue;

                for(j = 0; j < bots[i].bullets.length; j++)
                {
                    if(bots[i].bullets[j].position.x > 90 || bots[i].bullets[j].position.x < -90 || bots[i].bullets[j].position.z > 90 || bots[i].bullets[j].position.z < -90)
                    {
                        bots[i].bullets[j].dispose();
                        bots[i].bullets.splice(j, 1);
                        j--;
                        break;
                    }

                    if(bots[i].bullets[j].intersectsMesh(p1.player, true))
                    {
                        p1.hp -= bots[i].cannonDamage;

                        bots[i].bullets[j].dispose();
                        bots[i].bullets.splice(j, 1);
                        j--;

                        var length = menuCanvas.children[3].children[0].children[0].width;

                        if( length < 35 && length > 25 )
                            menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                        else if(length < 25)
                            menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                        menuCanvas.children[3].children[0].children[0].width = Math.floor(60 * (p1.hp / p1.maxHP));

                        break;
                    }
                }


                for(j = 0; j < bots[i].mines.length; j++)
                {
                    if(bots[i].mines[j].intersectsMesh(p1.player, true))
                    {
                        p1.hp -= bots[i].mineDamage;

                        bots[i].mines[j].dispose();
                        bots[i].mines.splice(j, 1);
                        j--;

                        var length = menuCanvas.children[3].children[0].children[0].width;

                        if( length < 35 && length > 25 )
                            menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.9,0.5,0.1,0.8));
                        else if(length < 25)
                            menuCanvas.children[3].children[0].children[0].fill = new BABYLON.SolidColorBrush2D(new BABYLON.Color4(0.8,0,0,0.8));

                        menuCanvas.children[3].children[0].children[0].width = Math.floor(60 * (p1.hp / p1.maxHP));

                        break;
                    }
                }
            }



            if(p1.player.rotationQuaternion.x > 0.8 || p1.player.rotationQuaternion.z > 0.4  || p1.hp <= 0)
            {
                menuCanvas.children[3].children[0].children[0].levelVisible = false;
                p1.player.dispose();
                activeScreen = "gameOver";
                gameActive = false;
                levelUp = false;
                menuCanvas.children[4].levelVisible = true;
                return;
            }


            if(upgradeBox != null && p1.player.intersectsMesh(upgradeBox, true))
            {
                upgrades++;
                upgradeBox.dispose();
                upgradeBox = null;
            }


            if(enemies == 0)
            {
                level++;
                levelUp = true;
                activeScreen = "play";
                resetScene(true);
            }

            /*
            if(rem.length > 0)
            {
                while(rem.length > 0)
                {
                    var temp = rem.pop();
                    p1.bullets[temp].dispose();
                    p1.bullets.splice(rem[temp], 1);
                }
            }*/


            for(i = 0; i < bots.length; i++)
            {
                if(bots[i] == null)
                    continue;
                if(bots[i].hp <= 0)
                {
                    menuCanvas.children[3].children[i+1].children[0].levelVisible = false;
                    bots[i].player.dispose();
                    bots[i] = null;
                    enemies--;
                }
            }

        }

        var woodenBox;
        var upgradeBox;

        function createUpgradeBox()
        {
            if(upgradeBox != null)
                upgradeBox.dispose();
            upgradeBox = woodenBox.clone();
            upgradeBox.position = new BABYLON.Vector3(Math.floor(Math.random() * 200)-100, 15, Math.floor(Math.random() * 200)-100);
            upgradeBox.physicsImpostor = new BABYLON.PhysicsImpostor(upgradeBox, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.91, restitution: 0 }, scene);
        }

        function createBots(scene)
        {
            for(i = 0; i < bots.length; i++)
            {
                bots[i].player.position =  new BABYLON.Vector3(-20 * i , 20, 15);
                bots[i].player.physicsImpostor = new BABYLON.PhysicsImpostor(bots[i].player, BABYLON.PhysicsEngine.BoxImpostor, { mass: 100, friction: 0.91, restitution: 0 }, scene);

                new BABYLON.Group2D(
                {
                    parent: menuCanvas.children[3], id: "Botd#" + i, width: 80, height: 40, trackNode: bots[i].player, origin: BABYLON.Vector2.Zero(),
                    children:
                    [
                        new BABYLON.Rectangle2D(
                        {
                            id: "firstRecto"+i, width: 60, height: 10, x: -30, y: 50, origin: BABYLON.Vector2.Zero(), border: "#FFFFFFFF", fill: "#40C040CC"
                        })
                    ]
                });

                menuCanvas.children[3].children[i+1].children[0].levelVisible = false;
            }
        }


        function move()
        {
            for(i = 0; i < bots.length; i++)
            {
                if(bots[i] == null)
                    continue;

                if(bots[i].override == 0 && (bots[i].player.position.x > 70 || bots[i].player.position.x < -70 || bots[i].player.position.z > 70 || bots[i].player.position.z < -70))
                {
                    if(Math.floor((Math.random() * 2)) == 0)
                        bots[i].tempD = 9;
                    else
                        bots[i].tempD = 7;
                    bots[i].override = 10;
                }

                if(bots[i].override == 0)
                {
                    if(Math.floor((Math.random() * 128)) == 11 && bots[i].tempL < 3)
                        bots[i].tempL = 25;

                    else if (Math.floor((Math.random() * 128)) == 10 && bots[i].tempD < 3)
                        bots[i].tempD = 24;

                    if(bots[i].tempL > 0)
                    {
                        bots[i].player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);
                        bots[i].tempL--;
                    }
                    else if(bots[i].tempD > 0)
                    {
                        bots[i].player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);
                        bots[i].tempD--;
                    }
                    else
                    {
                        bots[i].player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);

                    }
                }



                if(bots[i].override > 0)
                {
                    if(bots[i].tempL > 0)
                    {
                        bots[i].player.rotate(BABYLON.Axis.Y, -0.05, BABYLON.Space.LOCAL);
                        bots[i].tempL--;
                    }
                    else if(bots[i].tempD > 0)
                    {
                        bots[i].player.rotate(BABYLON.Axis.Y, 0.05, BABYLON.Space.LOCAL);
                        bots[i].tempD--;
                    }
                    else
                    {
                        bots[i].player.translate(BABYLON.Axis.Z, -0.5, BABYLON.Space.LOCAL);
                        bots[i].override--;
                    }
                }


                if(Math.floor((Math.random() * 1280)) < 100)
                    bots[i].shoot(scene);

                if(Math.floor((Math.random() * 1280)) == 100)
                    bots[i].plant(scene);
            }
        }


        var canvas = document.getElementById('renderCanvas');
        var engine = new BABYLON.Engine(canvas, true);


        var activeScreen = "main";

        function create2D(scene)
        {

            var mainWindow = new BABYLON.Texture("assets/mainMenu.png", scene);
            mainWindow.hasAlpha = true;

            var upgradeWindow = new BABYLON.Texture("assets/upgradeMenu.png", scene);
            var upgradeButton = new BABYLON.Texture("assets/upgradeButton.png", scene);
            upgradeWindow.hasAlpha = true;
            upgradeButton.hasAlpha = true;

            var lol = new BABYLON.Texture("assets/enemies2.png", scene);
            var lol2 = new BABYLON.Texture("assets/score.png", scene);
            var lvl = new BABYLON.Texture("assets/level.png", scene);
            lol2.hasAlpha = true;
            lol.hasAlpha = true;
            lvl.hasAlpha = true;

            var gameOverWindow = new BABYLON.Texture("assets/gameOver.png", scene);
            gameOverWindow.hasAlpha = true;

            var middleX = engine.getRenderWidth() / 2;
            var middleY = engine.getRenderHeight() / 2;


            menuCanvas = new BABYLON.ScreenSpaceCanvas2D(scene,
            {
                id: "ScreenCanvas",
                size: new BABYLON.Size(engine.getRenderWidth(), engine.getRenderHeight()),
                backgroundFill: "#50505055",
                children:
                [
                    //MainMenu
                    new BABYLON.Group2D(
                    {
                        id: "GroupTag #", children:
                        [
                            new BABYLON.Sprite2D(mainWindow,
                            {
                                id: "mainWindow", marginAlignment: "h: center, v:center"
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX + 250, middleY - 80), new BABYLON.Vector2(middleX + 400, middleY - 80)], {
                                id: "play",
                                border: "#FFFFFFFF", borderThickness: 2
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX - 400, middleY - 165), new BABYLON.Vector2(middleX - 90,  middleY - 165)], {
                                id: "upgrades",
                                border: "#98181fFF", borderThickness: 2
                            })
                        ]
                    }),
                    //UpgradeMenu
                    new BABYLON.Group2D(
                    {
                        id: "GroupTag #", children:
                        [
                            new BABYLON.Sprite2D(upgradeWindow,
                            {
                                id: "mainRect", marginAlignment: "h: center, v:center"
                            }),

                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX - 380, middleY + 160), new BABYLON.Vector2(middleX - 320, middleY + 160)], {
                                id: "back",
                                border: "#FFFFFFFF", borderThickness: 2
                            }),

                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX + 230, middleY + 40), new BABYLON.Vector2(middleX + 360, middleY + 40)], {
                                id: "upgrade1",
                                border: "#98181fFF", borderThickness: 2
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX + 230, middleY - 50), new BABYLON.Vector2(middleX + 360, middleY - 50)], {
                                id: "upgrade2",
                                border: "#98181fFF", borderThickness: 2
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX + 230, middleY - 140), new BABYLON.Vector2(middleX + 360, middleY - 140)], {
                                id: "upgrade3",
                                border: "#98181fFF", borderThickness: 2
                            }),

                            new BABYLON.Sprite2D(upgradeButton,
                            {
                                id: "mainRect1", x: middleX + 220, y: middleY + 45
                            }),
                            new BABYLON.Sprite2D(upgradeButton,
                            {
                                id: "mainRect2", x: middleX + 220, y: middleY - 45
                            }),
                            new BABYLON.Sprite2D(upgradeButton,
                            {
                                id: "mainRect3", x: middleX + 220, y: middleY - 135
                            }),


                            new BABYLON.Text2D(p1.cannonDamage+"  ",
                            {
                                id: "text34", x: middleX + 120, y: middleY + 45,
                                fontName: "20pt Arial"
                            }),
                            new BABYLON.Text2D(p1.mineDamage+"  ",
                            {
                                id: "text35", x: middleX + 120, y: middleY - 45,
                                fontName: "20pt Arial"
                            }),
                            new BABYLON.Text2D(p1.hp+"  ",
                            {
                                id: "text36", x: middleX + 120,  y: middleY - 135,
                                fontName: "20pt Arial"
                            })
                        ]
                    }),

                    //PlayMenu
                    new BABYLON.Group2D(
                    {
                        id: "nekaj",
                        children:
                        [
                            new BABYLON.Rectangle2D(
                            {
                                id: "mainRect", x: 0, y: 0, width: 300, height: 80,
                                children:
                                [
                                    new BABYLON.Sprite2D(lol2,
                                    {
                                        id: "mainRect2", x: 0, y: 0,
                                    }),
                                    new BABYLON.Text2D(points+"  ",
                                    {
                                        id: "text",
                                        marginAlignment: "h: right, v:center",
                                        fontName: "20pt Arial"
                                    })
                                ]
                            }),
                            new BABYLON.Rectangle2D(
                            {
                                id: "mainRect2", x: 0, y: engine.getRenderHeight()-60, width: 300, height: 80,
                                children:
                                [
                                    new BABYLON.Sprite2D(lol,
                                    {
                                        id: "mainRect", marginAlignment: "h: center, v:center"
                                    }),
                                    new BABYLON.Text2D(enemies+"  ",
                                    {
                                        id: "text2",
                                        marginAlignment: "h: right, v: left",
                                        fontName: "20pt Arial"
                                    })
                                ]
                            }),
                            new BABYLON.Rectangle2D(
                            {
                                id: "mainRect3", x: middleX- 140, y: middleY*2 -70, width: 300, height: 80,
                                children:
                                [
                                    new BABYLON.Sprite2D(lvl,
                                    {
                                        id: "mainRec3t", x: +20, y: 8
                                    }),
                                    new BABYLON.Text2D(level+" ",
                                    {
                                        id: "text23",
                                        marginAlignment: "h: right, v: center",
                                        fontName: "20pt Arial"
                                    })
                                ]
                            }),

                        ]
                    }),

                    //HP
                    new BABYLON.Group2D(
                    {
                        id: "nekaj"
                    }),

                    //GameOverMenu
                    new BABYLON.Group2D(
                    {
                        id: "nekaj",
                        children:
                        [
                            new BABYLON.Sprite2D(gameOverWindow,
                            {
                                id: "mainRec3t", marginAlignment: "h: center, v:center"
                            }),
                            new BABYLON.Lines2D([new BABYLON.Vector2(middleX - 400, middleY - 165), new BABYLON.Vector2(middleX - 200, middleY - 165)], {
                                id: "upgrade3",
                                border: "#98181fFF", borderThickness: 2
                            })
                        ]
                    })

                ]
            });


            menuCanvas.children[0].children[1].levelVisible = false;
            menuCanvas.children[0].children[2].levelVisible = false;

            menuCanvas.children[1].levelVisible = false;
            menuCanvas.children[1].children[1].levelVisible = false;
            menuCanvas.children[1].children[2].levelVisible = false;
            menuCanvas.children[1].children[3].levelVisible = false;
            menuCanvas.children[1].children[4].levelVisible = false;

            if(levelUp)
                menuCanvas.children[2].levelVisible = true;
            else
                menuCanvas.children[2].levelVisible = false;

            menuCanvas.children[4].levelVisible = false;
            menuCanvas.children[4].children[1].levelVisible = false;
            if(levelUp)
                menuCanvas.children[0].levelVisible = false;
            else
                activeScreen = "main";
        }




        function handleClick(event)
        {
            if(gameActive)
                return;

            var x = event.clientX;
            var y = event.clientY;

            var middleX = engine.getRenderWidth() / 2;
            var middleY = engine.getRenderHeight() / 2;

            if(activeScreen == "main")
            {
                if(x > middleX + 250 && y < middleY + 80 && y > middleY + 25 && x < middleX + 400 )
                {
                    gameActive = true;
                    //changed = true;
                    activeScreen = "play";

                    menuCanvas.children[0].levelVisible = false;
                    menuCanvas.children[1].levelVisible = false;
                    menuCanvas.children[2].levelVisible = true;
                }
                else if(x > middleX - 400 && y < middleY + 165 && y > middleY + 110 && x < middleX - 90 )
                {
                    menuCanvas.children[0].levelVisible = false;
                    menuCanvas.children[1].levelVisible = true;
                    activeScreen = "upgrades";

                    if(upgrades > 0)
                    {
                        menuCanvas.children[1].children[5].levelVisible = true;
                        menuCanvas.children[1].children[6].levelVisible = true;
                        menuCanvas.children[1].children[7].levelVisible = true;
                    }
                    else
                    {
                        menuCanvas.children[1].children[5].levelVisible = false;
                        menuCanvas.children[1].children[6].levelVisible = false;
                        menuCanvas.children[1].children[7].levelVisible = false;
                    }
                }
            }
            else if(activeScreen == "upgrades")
            {
                if(x > middleX - 380 && y < middleY - 160 && y > middleY - 230 && x < middleX - 320 )
                {
                    menuCanvas.children[1].levelVisible = false;
                    menuCanvas.children[0].levelVisible = true;
                    activeScreen = "main";
                }
                else if(x > middleX + 220 && x < middleX + 370 && y > middleY - 85 && y < middleY -40 && upgrades > 0)
                {
                    upgrades--;
                    p1.upgradePrimary();
                }
                else if(x > middleX + 220 && x < middleX + 370 && y > middleY + 5 && y < middleY + 50 && upgrades > 0)
                {
                    upgrades--;
                    p1.upgradeSecondary();
                }
                else if(x > middleX + 220 && x < middleX + 370 && y > middleY + 95 && y < middleY + 140 && upgrades > 0)
                {
                    upgrades--;
                    p1.upgradeHealth();
                }
                else
                {
                    menuCanvas.children[1].children[1].levelVisible = false;
                    menuCanvas.children[1].children[2].levelVisible = false;
                    menuCanvas.children[1].children[3].levelVisible = false;
                    menuCanvas.children[1].children[4].levelVisible = false;
                }

                if(upgrades > 0)
                {
                    menuCanvas.children[1].children[5].levelVisible = true;
                    menuCanvas.children[1].children[6].levelVisible = true;
                    menuCanvas.children[1].children[7].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[1].children[5].levelVisible = false;
                    menuCanvas.children[1].children[6].levelVisible = false;
                    menuCanvas.children[1].children[7].levelVisible = false;
                }

            }
            else if(activeScreen == "gameOver")
            {
                if(x > middleX - 400 && y < middleY + 165 && y > middleY + 105 && x < middleX - 200)
                {
                    menuCanvas.children[4].levelVisible = false;
                    menuCanvas.children[0].levelVisible = true;
                    activeScreen = "main";
                    resetScene(false);
                }
                else
                {
                    //menuCanvas.children[4].children[1].levelVisible = false;
                }
            }

        }

        function handleMove(event)
        {
            if(gameActive)
                return;


            var x = event.clientX;
            var y = event.clientY;

            var middleX = engine.getRenderWidth() / 2;
            var middleY = engine.getRenderHeight() / 2;

            if(activeScreen == "main")
            {
                if(x > middleX + 250 && y < middleY + 80 && y > middleY + 25 && x < middleX + 400 )
                {
                    menuCanvas.children[0].children[1].levelVisible = true;
                }
                else if(x > middleX - 400 && y < middleY + 165 && y > middleY + 110 && x < middleX - 90 )
                {
                    menuCanvas.children[0].children[2].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[0].children[1].levelVisible = false;
                    menuCanvas.children[0].children[2].levelVisible = false;
                }
            }
            else if(activeScreen == "upgrades")
            {
                if(x > middleX - 380 && y < middleY - 160 && y > middleY - 230 && x < middleX - 320 )
                {
                    menuCanvas.children[1].children[1].levelVisible = true;
                }

                else if(x > middleX + 220 && x < middleX + 370 && y > middleY - 85 && y < middleY -40 && upgrades > 0)
                {
                    menuCanvas.children[1].children[2].levelVisible = true;
                }
                else if(x > middleX + 220 && x < middleX + 370 && y > middleY + 5 && y < middleY + 50 && upgrades > 0)
                {
                    menuCanvas.children[1].children[3].levelVisible = true;
                }
                else if(x > middleX + 220 && x < middleX + 370 && y > middleY + 95 && y < middleY + 140 && upgrades > 0)
                {
                    menuCanvas.children[1].children[4].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[1].children[1].levelVisible = false;
                    menuCanvas.children[1].children[2].levelVisible = false;
                    menuCanvas.children[1].children[3].levelVisible = false;
                    menuCanvas.children[1].children[4].levelVisible = false;
                }

                if(upgrades > 0)
                {
                    menuCanvas.children[1].children[5].levelVisible = true;
                    menuCanvas.children[1].children[6].levelVisible = true;
                    menuCanvas.children[1].children[7].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[1].children[5].levelVisible = false;
                    menuCanvas.children[1].children[6].levelVisible = false;
                    menuCanvas.children[1].children[7].levelVisible = false;
                }
            }
            else if(activeScreen == "gameOver")
            {
                if(x > middleX - 400 && y < middleY + 165 && y > middleY + 105 && x < middleX - 200)
                {
                    menuCanvas.children[4].children[1].levelVisible = true;
                }
                else
                {
                    menuCanvas.children[4].children[1].levelVisible = false;
                }
            }
            return;
        }

        var menuCanvas;
        var mine;

        var createScene = function()
        {
            var scene = new BABYLON.Scene(engine);

            var gravityVector = new BABYLON.Vector3(0,-19.81, 0);
            var physicsPlugin = new BABYLON.CannonJSPlugin();

            scene.enablePhysics(gravityVector, physicsPlugin);

            var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);

            create2D(scene);

            BABYLON.SceneLoader.ImportMesh("", "", "tank.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat0", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/Main Body.png", scene);

                tankMaterials[1] = new BABYLON.StandardMaterial("Mat1", scene);
                tankMaterials[1].diffuseTexture = new BABYLON.Texture("assets/player/Main Body 2.png", scene);

                tankMaterials[2] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[2].diffuseTexture = new BABYLON.Texture("assets/player/Turret.png", scene);

                tankMaterials[3] = new BABYLON.StandardMaterial("Mat3", scene);
                tankMaterials[3].diffuseTexture = new BABYLON.Texture("assets/player/Gun.png", scene);


                for(i = 0; i < tank.length; i++)
                {
                    tank[i].material = tankMaterials[i];
                }




                p1 = new Player("player", BABYLON.Mesh.MergeMeshes(tank));

                switch(level)
                {
                    case 1:     setUpLevel1(); break;
                    case 2:     setUpLevel2(); break;
                    default:    setUpLevel2(); break;
                }

                FPCamera.lockedTarget = p1.player;
                scene.activeCamera = FPCamera;

                p1.createPlayer(scene);

                createBots(scene);


            });


            BABYLON.SceneLoader.ImportMesh("", "", "box.obj", scene, function (meshes)
            {
                var material = new BABYLON.StandardMaterial("Mat0", scene);
                material.diffuseTexture = new BABYLON.Texture("assets/box/WoodPlanks_Color.jpg", scene);

                meshes[0].material = material;

                woodenBox = meshes[0];
            });

            BABYLON.SceneLoader.ImportMesh("", "", "mine.obj", scene, function (meshes)
            {
                tank = meshes;

                var tankMaterials = [];

                tankMaterials[0] = new BABYLON.StandardMaterial("Mat2", scene);
                tankMaterials[0].diffuseTexture = new BABYLON.Texture("assets/player/mine.png", scene);

                tank[0].material = tankMaterials[0];

                mine = BABYLON.Mesh.MergeMeshes(tank);

                mine.scaling(new BABYLON.Vector3(-100, 1, 1));
                mine.rotate(BABYLON.Axis.Z, -0.05, BABYLON.Space.LOCAL);


            });




            var spriteManagerTrees = new BABYLON.SpriteManager("treesManager", "assets/tree1.png", 20, 600, scene);
            var spriteManagerTrees3 = new BABYLON.SpriteManager("treesManager", "assets/tree3.png", 20, 1083, scene);


            for (i = 0; i < 20; i++)
            {
                var tree = new BABYLON.Sprite("tree", spriteManagerTrees);
                tree.position.x = Math.random() * 195 - 100;
                tree.position.z = Math.random() * 195 - 100;
                tree.position.y = 15;
                tree.width = 10;
                tree.height = 10;
            }
            for (i = 0; i < 20; i++)
            {
                var tree = new BABYLON.Sprite("tree", spriteManagerTrees3);
                tree.position.x = Math.random() * 195 - 100;
                tree.position.z = Math.random() * 195 - 100;
                tree.position.y = 15;
                tree.width = 10;
                tree.height = 10;
            }



            controlCamera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 150, 45), scene);
            controlCamera.setTarget(BABYLON.Vector3.Zero());


            FPCamera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 15, 45), scene);
            FPCamera.radius = 30;
            FPCamera.heightOffset = 10;
            FPCamera.rotationOffset = 0;



            var skybox = BABYLON.Mesh.CreateBox("skyBox", 400.0, scene);            //400
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/skybox/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;




            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("assets/gravel3.jpg", scene);


            ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "assets/Heightmap.png", 200, 200, 50, 0, 40, scene, false, function ()
            {
                ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0}, scene);
                ground.material = groundMaterial;

            });


            /*
            var ground = BABYLON.Mesh.CreateGround('ground1', 60, 60, 2, scene);
            ground.setPhysicsState(BABYLON.PhysicsEngine.HeightmapImpostor, { mass: 0 });
            ground.material = groundMaterial;
            */

            window.addEventListener("keydown", function(evt)
            {
                keys[evt.keyCode] = true;

                if(keys[86])
                {
                    cam = ++cam % 3;
                    switch(cam)
                    {
                            case 0:     scene.activeCamera = FPCamera;
                                        FPCamera.lockedTarget = p1.player;
                                        FPCamera.radius = 30;
                                        FPCamera.heightOffset = 10;
                                        break;

                            case 1:     scene.activeCamera = FPCamera;
                                        FPCamera.lockedTarget = p1.player;
                                        FPCamera.radius = 30;
                                        FPCamera.heightOffset = 80;
                                        break;

                            case 2:     scene.activeCamera = controlCamera;
                                        break;
                    }
                }


                if(keys[88] && p1.mines.length < p1.mineLimit)
                    p1.plant(scene);

            }, false);

            window.addEventListener("keyup", function(evt)
            {
                keys[evt.keyCode] = false;
            }, false);



            if(levelUp)
            {
                gameActive = true;
            }

            //handleKeys();

            return scene;

    }


    var scene = createScene();
    var a = 0;
    engine.runRenderLoop(function()
    {
        if(gameActive && scene.isReady())
        {
            move();
            check(scene);
            if(!levelUp)
                handleKeys();
            if(gameActive && !levelUp)
            {
                menuCanvas.children[2].children[0].children[1].text = points+"  ";
                menuCanvas.children[2].children[1].children[1].text = enemies+"  ";

                //menuCanvas.children[3].children[0].children[0].children[0].text = "HP: "+p1.hp;
                if(a == 0)
                {
                    for(i = 0; i <= bots.length; i++)
                    {
                        menuCanvas.children[3].children[i].children[0].levelVisible = true;
                    }

                    a++;
                }

                if(Math.floor((Math.random() * 128)) == 11)
                {
                    createUpgradeBox();
                }
            }
            levelUp = false;
        }
        scene.render();
    });



    window.addEventListener('resize', function() {
        engine.resize();
    });

    </script>
</body>
</html>
